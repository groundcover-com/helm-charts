{{ if .Values.agent.enabled }}
apiVersion: v1
data:
  config.yaml: |
    LogLevel: 4
    resourceconntimeout: 1m0s
    concurrency: 10
    productchansize: 20480
    k8sloadtimeout: 2m0s
    resyncDuration: 1h
    unavailableDeploymentPollInterval: 10s
    summarizerActiveTtl: 180s
    pushsummaries: true
    productmetricsflushmintotalcounter:
      deployment_event: 1
      unavailable_deployment: 1

    Promscale:
      url: "{{ template "promscale.otelURL" . }}"
      tls: "true"
      tableWriterBatchMaxSize: 350
      tableWriterBatchInterval: 1s
      tableWriterBatchWriteTimeout: 1m

    deploymenteventhandler:
      samplesthreshold: 100
      issuesthreshold: 100
      interval: 60s
      shouldsample: false

    unavailabledeploymenthandler:
      samplesthreshold: 100
      issuesthreshold: 100
      interval: 60s
      shouldsample: true         

    dataRetention: {{ .Values.agent.alligator.dataRetention }}
    
    runningNamespace: ""
    clusterId: {{ .Values.clusterId }}
    region: {{ .Values.region }}
    shouldDropRunningNamespaces: {{ .Values.shouldDropRunningNamespaces }}
    tracesNamespaceFilters: {{ toYaml .Values.tracesNamespaceFilters | nindent 6 }}
    tracesWorkloadFilters: {{ toYaml .Values.tracesWorkloadFilters | nindent 6 }}
    commitHashKeyName: {{ .Values.commitHashKeyName }}
    repositoryUrlKeyName: {{ .Values.repositoryUrlKeyName }}
    shepherd:
      url: "{{ template "shepherd.grpc" . }}"
      enableTLS: {{ template "shepherd.tls_enabled" . }}
kind: ConfigMap
metadata:
  labels:
    {{ with .Values.global.groundcoverLabels }} 
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- if .Values.portal.additionalLabels }}
{{ toYaml .Values.portal.additionalLabels | indent 4 }}
    {{- end }}
  annotations:
    groundcover_version: {{ default .Chart.AppVersion .Values.global.origin.tag }}
    {{- if .Values.portal.additionalAnnotations }}
{{ toYaml .Values.portal.additionalAnnotations | indent 4 }}
    {{- end }}
  name: k8s-watcher-config
  namespace: {{ .Release.Namespace }}
{{ end }}