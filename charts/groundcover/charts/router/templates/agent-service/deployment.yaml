{{- if index .Values "agent-service" "enabled" }}
{{- $agentService := index .Values "agent-service" }}
{{- $postgres := $agentService.postgres }}
{{- $gitbook := $agentService.gitbook }}
{{- $longTermMemory := $agentService.longTermMemory }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-agent-service
  labels:
    app: {{ .Release.Name }}-agent-service
    {{- include "router.labels" . | nindent 4 }}
spec:
  replicas: {{ $agentService.replicas }}
  selector:
    matchLabels:
      app: {{ .Release.Name }}-agent-service
  {{- with $agentService.strategy }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-agent-service
        app.kubernetes.io/name: agent-service
        app.kubernetes.io/part-of: groundcover
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    spec:
      serviceAccountName: router
      imagePullSecrets: {{ include "router.imagePullSecrets" . }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      initContainers:
        # Create the agent_service database if it doesn't exist
        - name: init-postgres-db
          image: "{{ $agentService.initImage.repository }}:{{ $agentService.initImage.tag }}"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
          command:
            - /bin/sh
            - -c
            - |
              # Default to port 5432 if not set
              POSTGRES_PORT="${POSTGRES_PORT:-5432}"
              echo "Checking if database ${POSTGRES_DATABASE} exists..."
              PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -U "${POSTGRES_USERNAME}" -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '${POSTGRES_DATABASE}'" | grep -q 1 || \
              PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -U "${POSTGRES_USERNAME}" -d postgres -c "CREATE DATABASE ${POSTGRES_DATABASE}"
              echo "Database ${POSTGRES_DATABASE} is ready"
          env:
            - name: POSTGRES_HOST
              valueFrom:
                secretKeyRef:
                  name: {{ $postgres.secretName | default "managed-postgres-credentials" }}
                  key: {{ $postgres.hostKey | default "host" }}
            - name: POSTGRES_PORT
              valueFrom:
                secretKeyRef:
                  name: {{ $postgres.secretName | default "managed-postgres-credentials" }}
                  key: {{ $postgres.portKey | default "port" }}
                  optional: true
            - name: POSTGRES_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ $postgres.secretName | default "managed-postgres-credentials" }}
                  key: {{ $postgres.usernameKey | default "username" }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $postgres.secretName | default "managed-postgres-credentials" }}
                  key: {{ $postgres.passwordKey | default "password" }}
            - name: POSTGRES_DATABASE
              value: {{ $postgres.database | default "agent_service" | quote }}
      containers:
        - name: agent-service
          image: "{{ $agentService.image.repository }}:{{ tpl $agentService.image.tag $ }}"
          imagePullPolicy: {{ $agentService.image.pullPolicy }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: GITBOOK_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ $gitbook.secretName | default "gitbook-credentials" }}
                  key: {{ $gitbook.apiTokenKey | default "api-token" }}
            - name: GITBOOK_ORGANIZATION_ID
              valueFrom:
                secretKeyRef:
                  name: {{ $gitbook.secretName | default "gitbook-credentials" }}
                  key: {{ $gitbook.organizationIdKey | default "organization-id" }}
            - name: GITBOOK_SITE_ID
              valueFrom:
                secretKeyRef:
                  name: {{ $gitbook.secretName | default "gitbook-credentials" }}
                  key: {{ $gitbook.siteIdKey | default "site-id" }}
            - name: GITBOOK_SPACE_ID
              valueFrom:
                secretKeyRef:
                  name: {{ $gitbook.secretName | default "gitbook-credentials" }}
                  key: {{ $gitbook.spacesIdKey | default "space-id" }}
            - name: ROUTER_URL
              value: {{ $agentService.config.routerUrl | quote }}
            {{- if $agentService.config.awsRegion }}
            - name: AWS_REGION
              value: {{ $agentService.config.awsRegion | quote }}
            {{- end }}
            {{- if $agentService.config.bedrockModelId }}
            - name: BEDROCK_MODEL_ID
              value: {{ $agentService.config.bedrockModelId | quote }}
            {{- end }}
            {{- if $agentService.config.bedrockLargeModelId }}
            - name: ORCHESTRATOR_MODEL_ID
              value: {{ $agentService.config.bedrockLargeModelId | quote }}
            {{- end }}
            - name: OTEL_TRACING_ENABLED
              value: {{ $agentService.config.otelTracingEnabled | quote }}
            - name: OTEL_SERVICE_NAME
              value: {{ $agentService.config.otelServiceName | quote }}
            {{- if $agentService.config.otelExporterOtlpEndpoint }}
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: {{ $agentService.config.otelExporterOtlpEndpoint | quote }}
            {{- end }}
            - name: DEV_SHOW_TRACE_ID
              value: {{ $agentService.config.devShowTraceId | default "false" | quote }}
            - name: LANGSMITH_OTEL_ENABLED
              value: {{ $agentService.config.langsmithOtelEnabled | default "true" | quote }}
            - name: LANGSMITH_OTEL_ONLY
              value: {{ $agentService.config.langsmithOtelOnly | default "true" | quote }}
            - name: LANGSMITH_TRACING
              value: {{ $agentService.config.langsmithTracing | default "true" | quote }}
            - name: LANGSMITH_PROJECT_NAME
              value: {{ $agentService.config.langsmithProjectName | default "agent-service" | quote }}
            - name: POSTGRES_HOST
              valueFrom:
                secretKeyRef:
                  name: {{ $postgres.secretName | default "managed-postgres-credentials" }}
                  key: {{ $postgres.hostKey | default "host" }}
            - name: POSTGRES_PORT
              valueFrom:
                secretKeyRef:
                  name: {{ $postgres.secretName | default "managed-postgres-credentials" }}
                  key: {{ $postgres.portKey | default "port" }}
            - name: POSTGRES_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ $postgres.secretName | default "managed-postgres-credentials" }}
                  key: {{ $postgres.usernameKey | default "username" }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $postgres.secretName | default "managed-postgres-credentials" }}
                  key: {{ $postgres.passwordKey | default "password" }}
            - name: POSTGRES_DATABASE
              value: {{ $postgres.database | default "agent_service" | quote }}
            {{- if $longTermMemory }}
            - name: LONG_TERM_MEMORY_ENABLED
              value: {{ $longTermMemory.enabled | default false | quote }}
            {{- if $longTermMemory.enabled }}
            - name: LONG_TERM_MEMORY_EMBEDDING_DIMS
              value: {{ $longTermMemory.embeddingDims | default 1024 | quote }}
            - name: LONG_TERM_MEMORY_EMBEDDING_MODEL
              value: {{ $longTermMemory.embeddingModel | default "bedrock:amazon.titan-embed-text-v2:0" | quote }}
            - name: LONG_TERM_MEMORY_NAMESPACE
              value: {{ $longTermMemory.namespace | default "sre_agent_memories" | quote }}
            - name: LONG_TERM_MEMORY_NAMESPACE_PER_DEPLOYMENT
              value: {{ $longTermMemory.namespacePerDeployment | default false | quote }}
            {{- if $longTermMemory.namespacePerDeployment }}
            - name: LONG_TERM_MEMORY_DEV_USER
              value: {{ required "agent-service.longTermMemory.devUser is required when namespacePerDeployment=true" $longTermMemory.devUser | quote }}
            {{- end }}
            - name: ENABLE_DIRECT_MEMORY_MANAGEMENT_TOOLS
              value: {{ $longTermMemory.enableDirectMemoryManagementTools | default false | quote }}
            {{- end }}
            {{- end }}
            {{- with $agentService.env }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          resources:
            {{- toYaml $agentService.resources | nindent 12 }}
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 30
      {{- with $agentService.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $agentService.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $agentService.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
