{{- if .Values.global.temporal.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-temporal-namespace-setup-{{ randAlphaNum 6 | lower }}
  namespace: {{ .Release.Namespace }}
  {{- with .Values.temporalConfig.namespaceSetup.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  labels:
    app.kubernetes.io/name: temporal-namespace-setup
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: temporal
spec:
  backoffLimit: 10
  activeDeadlineSeconds: 600
  ttlSecondsAfterFinished: 43200
  template:
    metadata:
      labels:
        app.kubernetes.io/name: temporal-namespace-setup
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: temporal
    spec:
      restartPolicy: OnFailure
      {{- with include "temporal.nodeSelector" . }}
      nodeSelector:
        {{- . | nindent 8 }}
      {{- end }}
      {{- with include "temporal.tolerations" . }}
      tolerations:
        {{- . | nindent 8 }}
      {{- end }}
      {{- with include "temporal.nodeAffinity" . }}
      affinity:
        nodeAffinity:
          {{- . | nindent 10 }}
      {{- end }}
      containers:
      - name: create-namespace
        image: "{{ .Values.temporalConfig.adminTools.image.repository }}:{{ .Values.temporalConfig.adminTools.image.tag }}"
        env:
        - name: TEMPORAL_ADDRESS
          value: "{{ .Release.Name }}-temporal-frontend:7233"
        command: ["/bin/bash", "-c"]
        args:
        - |
          set -ex

          echo "Waiting for Temporal frontend to be ready..."
          for i in {1..60}; do
            if tctl --address $TEMPORAL_ADDRESS cluster health 2>/dev/null | grep -q SERVING; then
              echo "Temporal frontend is ready"
              break
            fi
            echo "Attempt $i/60: Temporal frontend not ready yet, waiting..."
            sleep 5
          done

          echo "Checking if default namespace exists..."
          if tctl --address $TEMPORAL_ADDRESS namespace list 2>/dev/null | grep -q "^Name: default$"; then
            echo "Default namespace already exists, skipping creation"
          else
            echo "Creating default namespace..."
            tctl --address $TEMPORAL_ADDRESS namespace register \
              default \
              --description "Default namespace for Temporal workflows" \
              --retention 7d \
              --active_cluster active || {
                echo "Namespace registration failed, checking if it was created by another process..."
                if tctl --address $TEMPORAL_ADDRESS namespace list 2>/dev/null | grep -q "^Name: default$"; then
                  echo "Default namespace exists now (created by another process)"
                else
                  echo "Failed to create namespace"
                  exit 1
                fi
            }
            echo "Default namespace created successfully"
          fi

          echo "Namespace setup complete"
{{- end }}