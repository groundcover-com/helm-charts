postgresql:
  dbs: {}
  nameOverride: postgresql
  image:
    registry: public.ecr.aws/groundcovercom
    repository: bitnami/postgresql
    tag: 15.3.0-debian-11-r75
  tls:
    enabled: true
    autoGenerated: true
  serviceAccount:
    create: true
  commonLabels: '{{ include "groundcover.labels" . }}'
  volumePermissions:
    enabled: true
    image:
      registry: public.ecr.aws/groundcovercom
      repository: bitnami/os-shell
      tag: 11-debian-11-r19
  primary:
    containerSecurityContext:
      enabled: false
    podSecurityContext:
      enabled: false
    extraEnvVars:
      - name: INITDB_PGHOST
        value: localhost
      - name: INITDB_PGPORT
        value: '{{ splitList ":" (include "postgresql.base.url" .) | last }}'

    initdb:
      scripts: 
        create-dbs.sh: |
          #!/bin/sh

          set -eu

          export PGHOST=${INITDB_PGHOST}
          export PGPORT=${INITDB_PGPORT}
          export PGPASSWORD=${POSTGRES_PASSWORD}

          create_database_if_not_exists() {
            local target_db="$1"
            echo "SELECT 'CREATE DATABASE ${target_db}' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '${target_db}')\gexec" | psql -U postgres
          }

          set -x
          {{ range $service, $db := .Values.dbs }}
          create_database_if_not_exists "{{ $db }}"
          {{- end }}
